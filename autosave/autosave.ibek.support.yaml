# yaml-language-server: $schema=https://github.com/epics-containers/ibek/releases/download/3.1.0/ibek.support.schema.json

module: autosave

entity_models:
  - name: Autosave
    description: |-
      Autosave and restore support for EPICS IOCs
    parameters:
      iocName:
        type: str
        description: |-
          IOC Name EPICS prefix

      P:
        type: str
        description: |-
          PV prefix for autosave status PVs

      debug:
        type: int
        description: |-
          Debug level
        default: 0

      positions_req_period:
        type: int
        description: |-
          no. secs between positions save file updates. 0 for no save file
        default: 0 # set to 5 for DLS motors

      setting_req_period:
        type: int
        description: |-
          no. secs between settings save file updates. 0 for no save file
        default: 30

      path:
        type: str
        description: |-
          Root of path to put autosave files in, ioc name will be appended to this

      num_seq_files:
        type: int
        description: |-
          Number of sequence files to keep
        default: 3

      sequence_period:
        type: int
        description: |-
          Period in seconds between sequence files
        default: 600

      backups:
        type: bool
        description: |-
          If True, create dated backup files
        default: True

    pre_init:
      - value: |
          # Autosave and restore initialisation
          set_requestfile_path("/epics", "autosave")
          save_restoreSet_status_prefix {{ P }}
          save_restoreSet_Debug {{ debug }}
          save_restoreSet_NumSeqFiles {{ num_seq_files }}
          save_restoreSet_SeqPeriodInSeconds {{ sequence_period }}
          save_restoreSet_DatedBackupFiles {{ backups }}
          save_restoreSet_IncompleteSetsOk 1
          {{ if positions_req_period != 0 -}}
          set_pass0_restoreFile /epics/runtime/autosave_positions.req
          {{- endif }}
          {{ if setting_req_period != 0 -}}
          set_pass1_restoreFile /epics/runtime/autosave_settings.req
          {{- endif }}

    post_init:
      - value: |
          {{ if positions_req_period != 0 -}}
          create_monitor_set "%s_0.req",  5, ""
          {{- endif }}
          {{ if setting_req_period != 0 -}}
          set_pass1_restoreFile /epics/runtime/autosave_settings.req
          {{- endif }}

          create_monitor_set "%s_1.req", 30, ""
